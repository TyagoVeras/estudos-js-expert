# EXAMPLE USAGE:
#
#   Refer for explanation to following link:
#   https://github.com/evilmartians/lefthook/blob/master/docs/configuration.md
#
pre-push:
  parallel: false
  commands:
    check-branch:
      run: |
        current_branch=$(git rev-parse --abbrev-ref HEAD)
        SWHITELIST_BRANCHES=("release" "master" "main")
        if [[ " ${SWHITELIST_BRANCHES[@]} " =~ " ${current_branch} " ]]; then
          echo "Error: Push para a branch '${current_branch}' não é permitido."
          exit 1
        fi

    ensure-clean-working-directory:
      run: |
        if ! git diff --quiet || ! git diff --cached --quiet; then
          echo "Error: O diretório de trabalho não está limpo. Por favor, faça commit ou stash das alterações."
          exit 1
        fi

    update-develop:
      run: |
        if ! git rev-parse --verify develop >/dev/null 2>&1; then
          echo "A branch 'develop' não existe localmente. Criando a branch 'develop'..."
          if ! git checkout -b develop; then
            echo "Error: Não foi possível criar a branch 'develop' localmente."
            exit 1
          fi

          # Tenta fazer push da branch develop para o repositório remoto
          if ! git push --set-upstream origin develop; then
            echo "Error: Não foi possível criar a branch 'develop' no repositório remoto."
            exit 1
          fi
        else
          if ! git checkout develop; then
            echo "Error: Não foi possível fazer checkout na branch 'develop'."
            exit 1
          fi
        fi

        # Puxa as últimas alterações da branch develop, se ela existir no remoto
        if ! git pull origin develop --rebase; then
          echo "Error: Não foi possível atualizar a branch 'develop' com a remota."
          exit 1
        fi

    rebase-current-branch:
      run: |
        if ! git checkout $current_branch; then
          echo "Error: Não foi possível voltar para a branch atual '${current_branch}'."
          exit 1
        fi

        if ! git rebase develop; then
          echo "Error: O rebase da branch 'develop' na branch '${current_branch}' falhou. Por favor, resolva os conflitos de merge e continue o rebase."
          exit 1
        fi

    push-current-branch:
      run: |
        if ! git push; then
          echo "Error: Não foi possível fazer push da branch '${current_branch}' para o repositório remoto."
          exit 1
        fi

pre-commit:
  parallel: true
  commands:
    tsc:
      tags: ci
      run: echo "tsc"